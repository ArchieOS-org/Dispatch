# SwiftLint + SwiftFormat Workflow
# Runs linting, formatting checks, and design import gating

name: Lint & Format

on:
  push:
  pull_request:

env:
  SWIFTFORMAT_MIN_VERSION: "0.54.6"
  SWIFTLINT_MIN_VERSION: "0.57.0"

jobs:
  lint-format:
    name: Lint & Format
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-brew-swiftformat-${{ env.SWIFTFORMAT_MIN_VERSION }}-swiftlint-${{ env.SWIFTLINT_MIN_VERSION }}

      - name: Install tools + print versions
        run: |
          brew install swiftformat swiftlint

          swiftformat --version
          swiftlint version

      - name: Lint
        run: |
          if swiftlint lint --help | grep -q -- '--path'; then
            swiftlint lint --strict --path Dispatch --config .swiftlint.yml
          else
            swiftlint lint --strict Dispatch --config .swiftlint.yml
          fi

      - name: Check Formatting
        run: |
          echo "SwiftFormat binary: $(which swiftformat)"
          swiftformat --version

          cat .swiftformat.airbnb .swiftformat \
            | grep -vE 'prefer-synthesized-init-for-internal-structs|wrapFunctionBodies|wrapPropertyBodies|testSuiteAccessControl|validateTestCases|simplifyGenericConstraints' \
            > .swiftformat.ci

          swiftformat Dispatch --lint --config .swiftformat.ci || {
            echo "---- .swiftformat.ci ----"
            sed -n '1,220p' .swiftformat.ci
            exit 1
          }

      - name: Gate Design imports
        run: |
          DOMAIN_TYPES='\b(User|Priority|Role|ClaimState|AppState|Listing|TaskItem|Activity|WorkItem)\b'
          FORBIDDEN_IMPORTS='^import\s+(Features|SharedUI)\b'

          VIOLATIONS=$(grep -rEn --include="*.swift" -E "(${FORBIDDEN_IMPORTS}|${DOMAIN_TYPES})" Dispatch/Design || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "❌ Design/ contains domain imports or types:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "✅ Design/ is clean of domain dependencies"
