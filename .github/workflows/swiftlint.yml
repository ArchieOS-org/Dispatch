# Lint & Format Workflow
# Uses pinned tool versions identical to local CI Mirror
# Runs on Linux for faster CI (no macOS runner capacity constraints)

name: Lint & Format

on:
  push:
  pull_request:

env:
  SWIFTLINT_VERSION: "0.57.0"
  SWIFTFORMAT_VERSION: "0.54.6"

jobs:
  lint-format:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Tools
        uses: actions/cache@v4
        with:
          path: tools
          key: tools-linux-v1-swiftlint-${{ env.SWIFTLINT_VERSION }}-swiftformat-${{ env.SWIFTFORMAT_VERSION }}

      - name: Install Tools (Linux)
        run: |
          mkdir -p tools

          # Install SwiftLint if not cached
          if [ ! -f tools/swiftlint ]; then
            echo "Downloading SwiftLint ${SWIFTLINT_VERSION} for Linux..."
            curl -sL "https://github.com/realm/SwiftLint/releases/download/${SWIFTLINT_VERSION}/swiftlint_linux.zip" -o /tmp/swiftlint.zip
            unzip -q /tmp/swiftlint.zip -d tools/
            chmod +x tools/swiftlint
          fi

          # Install SwiftFormat if not cached
          if [ ! -f tools/swiftformat ]; then
            echo "Downloading SwiftFormat ${SWIFTFORMAT_VERSION} for Linux..."
            curl -sL "https://github.com/nicklockwood/SwiftFormat/releases/download/${SWIFTFORMAT_VERSION}/swiftformat_linux.zip" -o /tmp/swiftformat.zip
            unzip -q /tmp/swiftformat.zip -d tools/
            chmod +x tools/swiftformat
          fi

      - name: Diagnostics
        run: |
          echo "SwiftFormat: $(./tools/swiftformat --version)"
          echo "SwiftLint: $(./tools/swiftlint version)"

      - name: Validate SwiftFormat Config
        run: |
          ./tools/swiftformat --lint --config .swiftformat.ci --dryrun Dispatch 2>&1 | tee /tmp/sf-validate.log
          if grep -qiE "unknown (rule|option)" /tmp/sf-validate.log; then
            echo "Error: .swiftformat.ci contains unsupported rules"
            exit 1
          fi

      - name: SwiftLint
        run: ./tools/swiftlint lint --strict Dispatch --config .swiftlint.yml

      - name: SwiftFormat
        run: ./tools/swiftformat Dispatch --lint --config .swiftformat.ci

      - name: Design Gate
        run: |
          DOMAIN_TYPES='\b(User|Priority|Role|ClaimState|AppState|Listing|TaskItem|Activity|WorkItem)\b'
          FORBIDDEN_IMPORTS='^import\s+(Features|SharedUI)\b'
          VIOLATIONS=$(grep -rEn --include="*.swift" -E "(${FORBIDDEN_IMPORTS}|${DOMAIN_TYPES})" Dispatch/Design || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "Error: Design/ contains domain imports or types:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "Design/ is clean"
