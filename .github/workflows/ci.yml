# Dispatch CI Workflow
# Builds and tests macOS + iOS + iPadOS

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_test:
    name: Build & Test (${{ matrix.platform }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos
            runs_on: macos-15
            destination: platform=macOS
          - platform: iphone
            runs_on: macos-15
            device_preferred: iPhone 15
            device_fallback: iPhone
          - platform: ipad
            runs_on: macos-15
            device_preferred: iPad (10th generation)
            device_fallback: iPad

    env:
      PROJECT: Dispatch.xcodeproj
      SCHEME: Dispatch
      DERIVED_DATA: DerivedData-${{ matrix.platform }}
      RESULT_BUNDLE: TestResults-${{ matrix.platform }}.xcresult

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          xcodebuild -version
          xcodebuild -showsdks | grep -E "(SDK|simulator)" || true

      - name: Diagnose schemes and destinations
        run: |
          set -euo pipefail
          echo "== Schemes =="
          xcodebuild -list -project "$PROJECT" || true

          # Surface destinations for each scheme
          for s in $(xcodebuild -list -project "$PROJECT" 2>/dev/null | awk '/Schemes:/,0 {print $1}' | tail -n +2); do
            echo "== Destinations for scheme: $s =="
            xcodebuild -showdestinations -project "$PROJECT" -scheme "$s" 2>/dev/null || true
          done

      - name: Diagnostics
        run: |
          xcodebuild -version
          xcodebuild -showsdks
          xcodebuild -list -project "$PROJECT"
          xcrun simctl list runtimes
          xcrun simctl list devices available

      - name: Ensure iOS Simulator platform present
        if: matrix.platform != 'macos'
        run: |
          SIM_PATH="$(xcode-select -p)/Platforms/iPhoneSimulator.platform"
          if [ ! -d "$SIM_PATH" ]; then
            echo "Missing iPhoneSimulator.platform at $SIM_PATH"
            exit 1
          fi
          ls "$SIM_PATH" >/dev/null

      - name: Validate scheme
        run: |
          python3 - <<'PY'
          import os
          import subprocess
          import sys

          project = os.environ["PROJECT"]
          scheme = os.environ["SCHEME"]
          output = subprocess.check_output(["xcodebuild", "-list", "-project", project], text=True)

          schemes = []
          capture = False
          for line in output.splitlines():
            stripped = line.strip()
            if stripped == "Schemes:":
              capture = True
              continue
            if capture:
              if not stripped:
                continue
              if line.startswith("    ") or line.startswith("\t"):
                schemes.append(stripped)
                continue
              break

          if scheme not in schemes:
            available = ", ".join(schemes) if schemes else "none"
            print(f"Scheme '{scheme}' not found. Available schemes: {available}")
            sys.exit(1)

          print(f"Using scheme: {scheme}")
          PY

      - name: Ensure iOS runtime available
        if: matrix.platform != 'macos'
        run: |
          python3 - <<'PY'
          import json
          import subprocess
          import sys

          data = subprocess.check_output(["xcrun", "simctl", "list", "runtimes", "-j"]).decode()
          runtimes = json.loads(data).get("runtimes", [])
          ios = [r for r in runtimes if r.get("isAvailable") and "iOS" in r.get("name", "")]
          if not ios:
            print("No available iOS runtimes found on this runner.")
            sys.exit(1)
          PY

      - name: Select scheme for platform
        run: |
          set -euo pipefail

          # Prefer platform-specific schemes if they exist
          CANDIDATES=("Dispatch-iOS" "Dispatch iOS" "Dispatch")

          pick_scheme() {
            local want="$1" # "iOS Simulator" or "macOS"
            for s in "${CANDIDATES[@]}"; do
              if xcodebuild -showdestinations -project "$PROJECT" -scheme "$s" 2>/dev/null | grep -q "$want"; then
                echo "$s"
                return 0
              fi
            done
            return 1
          }

          if [ "${{ matrix.platform }}" = "macos" ]; then
            SCHEME="$(pick_scheme "platform:macOS")"
          else
            SCHEME="$(pick_scheme "platform:iOS Simulator")"
          fi

          if [ -z "${SCHEME:-}" ]; then
            echo "::error::No scheme found exposing required destinations for ${{ matrix.platform }}"
            echo "Schemes:"
            xcodebuild -list -project "$PROJECT" || true
            echo "Destinations for default scheme (Dispatch):"
            xcodebuild -showdestinations -project "$PROJECT" -scheme "Dispatch" || true
            exit 1
          fi

          echo "Using scheme: $SCHEME"
          echo "SCHEME=$SCHEME" >> "$GITHUB_ENV"

      - name: Set destination (macOS)
        if: matrix.platform == 'macos'
        run: echo "DESTINATION=${{ matrix.destination }}" >> "$GITHUB_ENV"

      - name: Select simulator destination
        if: matrix.platform != 'macos'
        env:
          DEVICE_PREFERRED: ${{ matrix.device_preferred }}
          DEVICE_FALLBACK: ${{ matrix.device_fallback }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import subprocess
          import sys

          preferred = os.environ["DEVICE_PREFERRED"]
          fallback = os.environ["DEVICE_FALLBACK"]

          runtimes = json.loads(
            subprocess.check_output(["xcrun", "simctl", "list", "runtimes", "-j"]).decode()
          ).get("runtimes", [])
          ios_runtime_ids = {
            r["identifier"] for r in runtimes if r.get("isAvailable") and "iOS" in r.get("name", "")
          }
          if not ios_runtime_ids:
            print("No available iOS runtimes found on this runner.")
            sys.exit(1)

          devices_by_runtime = json.loads(
            subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]).decode()
          ).get("devices", {})

          available = []
          for runtime_id, devices in devices_by_runtime.items():
            if runtime_id not in ios_runtime_ids:
              continue
            for device in devices:
              if device.get("isAvailable"):
                available.append(device)

          def pick(prefix):
            for device in available:
              if device.get("name", "").startswith(prefix):
                return device
            return None

          device = pick(preferred) or pick(fallback)
          if not device:
            print(f"No available simulator found for '{preferred}' or fallback '{fallback}'.")
            print("Available devices:")
            for d in available:
              print(f"- {d.get('name')} ({d.get('udid')})")
            sys.exit(1)

          print(f"Selected simulator: {device['name']} ({device['udid']})")
          with open(os.environ["GITHUB_ENV"], "a") as env_file:
            env_file.write(f"DESTINATION=id={device['udid']}\n")
          PY

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
            .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "$PROJECT" \
            -scheme "$SCHEME"

      - name: Build & Test
        run: |
          set -euo pipefail

          SKIP_ARGS=""
          if [ "${{ matrix.platform }}" = "macos" ]; then
            # Skip iOS-only UI tests on macOS
            SKIP_ARGS="-skip-testing:DispatchUITests"
          fi

          xcodebuild test \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -configuration Debug \
            -derivedDataPath "$DERIVED_DATA" \
            -resultBundlePath "$RESULT_BUNDLE" \
            $SKIP_ARGS \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestResults-${{ matrix.platform }}
          path: ${{ env.RESULT_BUNDLE }}
          if-no-files-found: warn
          retention-days: 7
